# 测试用例：管理员竞赛管理

说明：覆盖管理员登录、创建竞赛、上传赛题ZIP（覆盖保存），并校验失败场景与文件落盘路径。

## 环境准备
- 后端服务：`uvicorn app.main:app --port 8081`
- 前端服务：`npm run dev`（开发环境通过 Vite 代理 `/api` 指向 `http://localhost:8081`）
- 管理员测试账号：`root/toor`（应用启动自动初始化）

## 用例列表

### 用例1：管理员登录成功
- 步骤：
  1. `POST /api/auth/adminManager-login`，Body：`{ account: "root", password: "toor" }`
  2. 读取返回 `data.token` 与 `data.role`
- 断言：
  - `code == 0`
  - `data.role == "admin"`
  - `data.token` 非空

### 用例2：创建竞赛成功
- 前置：使用用例1获取的管理员 `token`
- 步骤：
  1. `POST /api/admin/competitions`
     - Header：`Authorization: Bearer <token>`
     - Body：`{ name: "2025校赛", start_time: "<ISO>", end_time: "<ISO>" }`（`end_time > start_time`）
  2. 记录返回 `data.season.id`
- 断言：
  - `code == 0`
  - `data.season.id` 为数字且大于0
  - `data.season.name` 与请求一致

### 用例3：创建竞赛失败 - 名称重复
- 前置：已创建同名竞赛（用例2）
- 步骤：
  1. 再次 `POST /api/admin/competitions`，name 与用例2相同
- 断言：
  - HTTP 409 或返回 `{ code: 1004 }`
  - `message` 包含 "竞赛名称已存在"

### 用例4：创建竞赛失败 - 结束时间不合法
- 步骤：
  1. `POST /api/admin/competitions`，`end_time <= start_time`
- 断言：
  - HTTP 400 或返回 `{ code: 1001 }`
  - `message` 包含 "结束时间必须晚于开始时间"

### 用例5：上传赛题ZIP成功（首次）
- 前置：已获取 `seasonId`，且有管理员 `token`
- 步骤：
  1. `POST /api/admin/competitions/{seasonId}/problems/upload`
     - Header：`Authorization: Bearer <token>`
     - FormData：`file=@problems1.zip`（ZIP）
- 断言：
  - `code == 0`
  - `data.season_id == {seasonId}`
  - `data.filename` 结尾为 `.zip`
  - `data.size > 0`
  - `data.path` 为 `uploads/problems/season_{seasonId}.zip`

### 用例6：上传赛题ZIP成功（覆盖保存）
- 前置：已完成用例5
- 步骤：
  1. 再次 `POST /api/admin/competitions/{seasonId}/problems/upload`，上传不同内容的ZIP
- 断言：
  - `code == 0`
  - `data.hash` 与用例5不同（或 `data.size` 改变）
  - 目标文件路径与用例5一致（覆盖保存）

### 用例7：上传赛题失败 - 非ZIP文件
- 步骤：上传 `.txt` 或其他非 `.zip` 文件
- 断言：
  - HTTP 400 或返回 `{ code: 1001 }`
  - `message` 包含 "文件类型错误：仅支持 .zip"

### 用例8：上传赛题失败 - 竞赛不存在
- 步骤：使用不存在的 `seasonId`
- 断言：
  - HTTP 404 或返回 `{ code: 1005 }`
  - `message` 包含 "指定的竞赛不存在"

### 用例9：上传历年优秀作品成功（ZIP）
- 前置：已获取 `seasonId`，且有管理员 `token`
- 步骤：
  1. `POST /api/admin/competitions/{seasonId}/excellent/upload`
     - Header：`Authorization: Bearer <token>`
     - FormData：`file=@excellent.zip`（ZIP），`summary="模型简洁，结果稳定"`，`score=92.5`，`allow_download=true`
- 断言：
  - `code == 0`
  - `data.season_id == {seasonId}`
  - `data.filename` 结尾为 `.zip`
  - `data.size > 0`
  - `data.path` 以 `uploads/excellent/season_{seasonId}/work_` 开头
  - `data.hash` 非空

### 用例10：上传历年优秀作品成功（PDF，复用同一作品）
- 前置：已完成用例9（存在 `work_id`）
- 步骤：
  1. 再次 `POST /api/admin/competitions/{seasonId}/excellent/upload`，上传 `excellent.pdf`，不变更摘要与评分
- 断言：
  - `code == 0`
  - `data.filename` 结尾为 `.pdf`
  - `data.work_id` 与用例9返回一致（复用作品记录）
  - 目录保持 `uploads/excellent/season_{seasonId}/work_{work_id}/...`

### 用例11：上传优秀作品失败 - 非 zip/pdf 文件
- 步骤：上传 `.txt` 或其他不支持类型
- 断言：
  - HTTP 400 或返回 `{ code: 1001 }`
  - `message` 包含 "文件类型错误：仅支持 .zip 或 .pdf"

### 用例12：上传优秀作品失败 - 竞赛不存在
- 步骤：使用不存在的 `seasonId`
- 断言：
  - HTTP 404 或返回 `{ code: 1005 }`
  - `message` 包含 "指定的竞赛不存在"

## 参考命令（端到端）

以下命令演示如何在本地通过命令行完成端到端验证：

```bash
API=http://localhost:8081

# 1) 管理员登录
curl -s -H "Content-Type: application/json" -d '{"account":"root","password":"toor"}' \
  $API/api/auth/adminManager-login > /tmp/admin_login.json
TOKEN=$(python3 -c "import json,sys;d=json.load(open('/tmp/admin_login.json'));print(d['data']['token'])")

# 2) 创建竞赛（开始=1小时后，结束=24小时后）
START=$(python3 - <<'PY'
import datetime
print((datetime.datetime.utcnow()+datetime.timedelta(hours=1)).isoformat()+"Z")
PY
)
END=$(python3 - <<'PY'
import datetime
print((datetime.datetime.utcnow()+datetime.timedelta(hours=24)).isoformat()+"Z")
PY
)
PAYLOAD=$(printf '{"name":"2025校赛","start_time":"%s","end_time":"%s"}' "$START" "$END")
curl -s -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" -d "$PAYLOAD" \
  $API/api/admin/competitions > /tmp/comp.json
SID=$(python3 -c "import json;print(json.load(open('/tmp/comp.json'))['data']['season']['id'])")

# 3) 准备并上传ZIP（首次）
echo "hello" > /tmp/a.txt
zip -j -q /tmp/problems1.zip /tmp/a.txt
curl -s -H "Authorization: Bearer $TOKEN" -F "file=@/tmp/problems1.zip" \
  $API/api/admin/competitions/$SID/problems/upload > /tmp/upload1.json

# 4) 覆盖上传ZIP（内容不同）
echo "world" > /tmp/a.txt
zip -j -q /tmp/problems2.zip /tmp/a.txt
curl -s -H "Authorization: Bearer $TOKEN" -F "file=@/tmp/problems2.zip" \
  $API/api/admin/competitions/$SID/problems/upload > /tmp/upload2.json

# 5) 检查文件是否落盘
UPATH=$(python3 -c "import json;print(json.load(open('/tmp/upload2.json'))['data']['path'])")
test -f "$(pwd)/backend/$UPATH" && echo "File exists: backend/$UPATH" || echo "File missing: backend/$UPATH"

# 6) 输出关键结果摘要
echo "TOKEN: $(echo $TOKEN | cut -c1-20)..."
echo "SEASON ID: $SID"
python3 -c "import json;print('UPLOAD1 code=',json.load(open('/tmp/upload1.json'))['code'])"
python3 -c "import json;print('UPLOAD2 code=',json.load(open('/tmp/upload2.json'))['code'])"

# 7) 优秀作品上传（ZIP）
curl -sS -X POST \
  "http://localhost:8081/api/admin/competitions/${SID}/excellent/upload" \
  -H "Authorization: Bearer ${TOKEN}" \
  -F "file=@excellent.zip" \
  -F "summary=模型简洁，结果稳定" \
  -F "score=92.5" \
  -F "allow_download=true" \
  > /tmp/excellent1.json
python3 -c "import json;d=json.load(open('/tmp/excellent1.json'));print('EX1 code=',d['code'],'work_id=',d['data'].get('work_id'),'file=',d['data'].get('filename'),'path=',d['data'].get('path'))"

# 8) 优秀作品上传（PDF，复用同一作品）
curl -sS -X POST \
  "http://localhost:8081/api/admin/competitions/${SID}/excellent/upload" \
  -H "Authorization: Bearer ${TOKEN}" \
  -F "file=@excellent.pdf" \
  > /tmp/excellent2.json
python3 -c "import json;d=json.load(open('/tmp/excellent2.json'));print('EX2 code=',d['code'],'work_id=',d['data'].get('work_id'),'file=',d['data'].get('filename'),'path=',d['data'].get('path'))"
```

> 注意：上述命令使用 Python 解析 JSON，避免 shell 引号导致的解析错误；确保后端已安装 `python-multipart` 以处理文件上传。