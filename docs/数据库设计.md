# 数据库设计（草案 v0.1）

本文档梳理数学建模校赛网站核心实体、字段、关系与索引设计，依据《需求文档.md》与《API文档.md》。

## 总览
- 账户：`admins`、`students`、`teachers`
- 赛事：`seasons`
- 队伍与成员：`teams`、`team_members`、`team_join_tokens`
- 文件：`problem_files`、`submissions`
- 评审：`review_dimensions`、`reviews`、`review_scores`
- 日志与展示：`audit_logs`、`login_logs`、`excellent_works`
 以及优秀作品文件：`excellent_work_files`

## 实体与字段

### admins（管理员）
- `id` PK, auto
- `account` varchar(64) unique index
- `name` varchar(64)
- `password_hash` varchar(128)

### students（学生）
- `id` PK, auto
- `student_id` varchar(32) unique index
- `name` varchar(64) index
- `college` varchar(64)
- `class_name` varchar(64)
- `email` varchar(128) index
- `password_hash` varchar(128)
- `active` bool default true
- `created_at` datetime default now

### teachers（教师）
- `id` PK, auto
- `account` varchar(64) unique index
- `name` varchar(64)
- `email` varchar(128) nullable
- `password_hash` varchar(128)
- `active` bool default true
- `created_at` datetime default now

### seasons（赛季/赛事活动）
- `id` PK, auto
- `name` varchar(128) unique index
- `signup_start` datetime
- `signup_end` datetime
- `start_time` datetime
- `submit_deadline` datetime
- `review_start` datetime
- `review_end` datetime
- `status` varchar(32) index（未开始/报名中/进行中/评审中/已结束）
- `created_at` datetime default now

### teams（队伍）
- `id` PK, auto
- `season_id` FK seasons.id index
- `team_code` varchar(32) unique index（内部队伍编号，系统生成，不对外展示）
- `name` varchar(128)
- `captain_id` FK students.id index
- `status` varchar(16) index（pending|approved|locked）
- `locked` bool default false
- `created_at` datetime default now

### team_members（队伍成员）
- `id` PK, auto
- `team_id` FK teams.id index
- `student_id` FK students.id index
- `role` varchar(16) default 'member'
- `joined_at` datetime default now
- Unique(`team_id`, `student_id`)

### team_join_tokens（队伍加入令牌）
- `id` PK, auto
- `team_id` FK teams.id index
- `token` varchar(128) index
- `expires_at` datetime
- `active` bool default true
- `created_at` datetime default now

### problem_files（赛题文件）
- `id` PK, auto
- `season_id` FK seasons.id index
- `filename` varchar(256)
- `size` int
- `hash` varchar(128)
- `path` varchar(512)
- `visible_after_start` bool default true
- `uploaded_at` datetime default now

### submissions（作品提交）
- `id` PK, auto
- `team_id` FK teams.id index
- `version` int default 1
- `filename` varchar(256)
- `note` varchar(256) nullable
- `hash` varchar(128)
- `uploaded_at` datetime default now

### review_dimensions（评分维度配置）
- `id` PK, auto
- `season_id` FK seasons.id index
- `key` varchar(32)
- `name` varchar(64)
- `weight` float default 1.0
- `max_score` float default 100.0
- `order` int default 0

### review_configs（评分全局配置）
- `id` PK, auto
- `season_id` FK seasons.id unique index
- `require_teacher_count` int default 3
- `anonymous_review` bool default true
- `created_at` datetime default now

### reviews（评分记录）
- `id` PK, auto
- `submission_id` FK submissions.id index
- `teacher_id` FK teachers.id index
- `comment` text nullable
- `created_at` datetime default now
- `updated_at` datetime default now on update

### review_scores（评分明细）
- `id` PK, auto
- `review_id` FK reviews.id index
- `dimension_key` varchar(32)
- `score` float
- Unique(`review_id`, `dimension_key`)

### audit_logs（操作日志）
- `id` PK, auto
- `actor_type` varchar(16)（admin/teacher/student）
- `actor_id` int
- `action` varchar(64)
- `object_type` varchar(32)
- `object_id` int
- `details` text nullable
- `created_at` datetime default now

### login_logs（登录日志）
- `id` PK, auto
- `role` varchar(16)（admin/teacher/student）
- `account` varchar(64)
- `success` bool default false
- `ip` varchar(64) nullable
- `created_at` datetime default now

### enrollments（报名记录）
- `id` PK, auto
- `season_id` FK seasons.id index
- `student_id` FK students.id index
- `status` varchar(16) default 'approved'（pending|approved|rejected）
- `created_at` datetime default now

### excellent_works（历年优秀作品）
- `id` PK, auto
- `season_id` FK seasons.id index
- `team_id` FK teams.id index
- `submission_id` FK submissions.id index
- `summary` text nullable
- `score` float nullable
- `allow_download` bool default false
- `created_at` datetime default now

### excellent_work_files（优秀作品文件记录，保留多文件）
- `id` PK, auto
- `work_id` FK excellent_works.id index
- `filename` varchar(256)
- `size` int
- `hash` varchar(128)
- `path` varchar(512)
- `uploaded_at` datetime default now

## 关系与约束
- seasons 1..* teams
- teams 1..* team_members（学生 ≤3，人，约束由业务层控制）
- teams 1..* submissions；保留历史版本，最终版由业务逻辑标记或取最新
- submissions 1..* reviews；reviews 1..* review_scores（维度明细）
- seasons 1..* review_dimensions（全局维度配置）
- seasons 1..1 review_configs（评分全局配置）
- excellent_works 关联季、队伍与提交
- excellent_work_files 1..* 对应 excellent_works（一个优秀作品可含 zip/pdf 多文件）

## 索引建议
- students(`student_id`) unique, (`email`) index
- teachers(`account`) unique
- teams(`season_id`, `name`) 组合索引（可选）
- submissions(`team_id`, `uploaded_at`) 组合索引
- reviews(`submission_id`, `teacher_id`) 组合索引
- review_scores(`review_id`, `dimension_key`) unique
- login_logs(`role`, `created_at`) 组合索引
- enrollments(`season_id`, `student_id`) unique
- excellent_work_files(`work_id`, `uploaded_at`) 组合索引（按时间查询）

## 备注
- 密码字段存储 PBKDF2-SHA256 哈希；不存原始密码
- 文件存储路径与签名下载策略由对象存储层实现
- 后续引入 Alembic 管理迁移