# 后端各个文件的作用（主要文件）

面向维护与交接，说明后端核心文件/目录的职责与关系。数据库为 MySQL，服务为 FastAPI。

## 项目与环境
- `backend/pyproject.toml`：后端依赖与构建系统配置（Poetry/PEP 517）。定义 FastAPI、SQLAlchemy、PyMySQL 等依赖。
- `backend/.venv/`：后端虚拟环境目录（本地开发使用）。
- `backend/backend.egg-info/`：打包/元数据目录（生成的发行信息）。
- `backend/scripts/export_audit_logs.py`：审计日志导出脚本（按需运行）。

## 应用入口与配置
- `backend/app/main.py`：FastAPI 应用入口。
  - 启动时初始化数据库连接与建表迁移；
  - 创建默认账号（管理员/学生/教师）与基础数据；
  - 注册路由与中间件（如 CORS）。
- `backend/app/config.py`：配置项与环境变量读取。
  - 包含数据库连接参数、上传目录、CORS 设置、默认管理员配置等。
- `backend/app/db.py`：数据库会话与连接管理。
  - 构建 `DATABASE_URL`（MySQL+PyMySQL）；
  - 提供 `get_db()` 依赖注入；
  - 初始化引擎与连接测试。

## 数据模型与安全
- `backend/app/models.py`：SQLAlchemy ORM 模型定义。
  - 用户、角色、队伍、竞赛、公告、提交、审计日志等核心数据结构；
  - 字段约束与索引，时间戳与状态字段。
- `backend/app/security.py`：鉴权与权限控制。
  - Token 生成与校验；
  - 管理员/教师/学生权限依赖；
  - 登录态与路由保护逻辑。
- `backend/app/audit.py`：审计日志记录工具。
  - 统一记录操作行为（创建、更新、删除等），包含主体、资源与时间。

## 路由层
- `backend/app/routers/`：REST API 路由集合（按模块划分）。
  - 管理员相关：
    - `admin.py`：管理员接口集合（队伍管理、用户审核、公告管理等）。
      - 公告管理：分页查询、创建、更新、删除；
      - 排序修复：使用 `CASE` 处理 `published_at` 的 NULL 排序，兼容 MySQL；
      - 审计与权限：所有写操作记录审计并校验管理员权限。
  - 公共接口：
    - `public.py`：公开数据查询与公共资源访问（含公告公开列表，排序同上修复）。
  - 其他模块：可能包含竞赛、队伍、用户注册/登录等路由。

## 上传与静态资源
- `backend/uploads/`：后端上传目录（题目、作品、优秀作品等子目录）。
  - `problems/`、`submissions/`、`excellent/`：按模块划分存放上传文件。

## 运行与联调要点
- 开发启动：在 `backend/` 下运行 `uvicorn app.main:app --reload --port 8000`。
- 数据库：`config.py` 提供连接参数；首次启动会进行建库/建表与默认数据初始化。
- CORS 与代理：前端通过 Vite 代理 `/api` 到后端 `http://localhost:8000`；生产环境建议使用同域或在后端配置 CORS。

---

维护建议：
- 新增模型时在 `models.py` 定义并更新建表逻辑；保持字段命名与约束一致性。
- 新增接口时在 `routers/` 下按模块创建路由，统一接入权限依赖与审计。
- 遇到数据库兼容性问题（如 `NULLS LAST`）优先使用 SQLAlchemy 表达式适配，如 `CASE`。
- 变更配置时更新 `config.py` 并在 `main.py` 初始化流程中考虑迁移/默认值。