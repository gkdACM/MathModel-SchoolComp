# 队伍测试用例（竞赛报名与队伍创建）

> 目标：系统性验证学生在报名开放与未开放状态下的队伍创建与加入流程是否符合预期；验证“我的队伍”查询与令牌刷新权限；确保前后端接口路径与校验逻辑一致。

## 测试前提与环境
- 后端地址：`http://localhost:8080/api`
- 前端地址：`http://localhost:5173/`
- 角色准备：至少准备两个学生账号（A=队长、B=成员）。参考 `docs/测试账号.md`
- 管理员账号用于切换报名开关（可选），参考 `docs/测试账号.md`

## 相关接口清单
- 公共：`GET /public/open-competitions`
- 学生：
  - `POST /student/competitions/{season_id}/teams`（创建队伍并报名）
  - `GET  /student/competitions/{season_id}/my-team`（查询我的队伍）
  - `POST /student/teams/join`（使用令牌加入队伍并报名）
  - `POST /student/teams/{team_id}/join-token`（队长刷新加入令牌）
- 管理员（可选）：`POST /admin/competitions/{season_id}/signup-toggle`（切换报名开关）

> 说明：后端学生路由在 `backend/app/routers/student.py`，报名开放判断统一由 `_signup_open(season)` 负责：当前时间位于 `[signup_start, signup_end]` 区间或 `allow_signup==True` 则视为开放。

## 准备步骤
1. 管理员登录并确认赛季 `season_id`（或由公共接口查询开放赛季）：
   ```bash
   curl -s -X GET 'http://localhost:8080/api/public/open-competitions'
   ```
   记录待测赛季 `season_id`。

2. 学生 A（预期队长）登录，获取 `STU_A_TOKEN`：
   ```bash
   curl -s -X POST 'http://localhost:8080/api/auth/student-login' \
     -H 'Content-Type: application/json' \
     -d '{"account":"<学生A账号>","password":"<密码>"}'
   # 响应中 data.token 即为 STU_A_TOKEN
   ```

3. 学生 B 登录，获取 `STU_B_TOKEN`：
   ```bash
   curl -s -X POST 'http://localhost:8080/api/auth/student-login' \
     -H 'Content-Type: application/json' \
     -d '{"account":"<学生B账号>","password":"<密码>"}'
   # 响应中 data.token 即为 STU_B_TOKEN
   ```

4. （可选）管理员登录，获取 `ADMIN_TOKEN`，用于切换报名开关：
   ```bash
   curl -s -X POST 'http://localhost:8080/api/auth/adminManager-login' \
     -H 'Content-Type: application/json' \
     -d '{"account":"<管理员账号>","password":"<密码>"}'
   # 响应中 data.token 即为 ADMIN_TOKEN
   ```

## 测试用例

### 用例1：报名未开放时创建队伍失败
- 前置：确保赛季未开放（`allow_signup=false` 且当前不在 `signup_start~signup_end`）
  ```bash
  # 可选：管理员关闭报名
  curl -s -X POST "http://localhost:8080/api/admin/competitions/<season_id>/signup-toggle" \
    -H "Authorization: Bearer <ADMIN_TOKEN>" \
    -H 'Content-Type: application/json' \
    -d '{"allow_signup":false}'
  ```
- 步骤：学生A创建队伍
  ```bash
  curl -i -X POST "http://localhost:8080/api/student/competitions/<season_id>/teams" \
    -H "Authorization: Bearer <STU_A_TOKEN>" \
    -H 'Content-Type: application/json' \
    -d '{"name":"测试队伍A"}'
  ```
- 预期：HTTP 400，`detail.code=1001`，`message=当前不在报名开放状态`

### 用例2：报名开放时创建队伍成功
- 前置：开启报名（两种方式其一）
  - 管理员打开开关：
    ```bash
    curl -s -X POST "http://localhost:8080/api/admin/competitions/<season_id>/signup-toggle" \
      -H "Authorization: Bearer <ADMIN_TOKEN>" \
      -H 'Content-Type: application/json' \
      -d '{"allow_signup":true}'
    ```
  - 或时间窗口命中：`now ∈ [signup_start, signup_end]`
- 步骤：学生A创建队伍
  ```bash
  curl -s -X POST "http://localhost:8080/api/student/competitions/<season_id>/teams" \
    -H "Authorization: Bearer <STU_A_TOKEN>" \
    -H 'Content-Type: application/json' \
    -d '{"name":"测试队伍A"}'
  ```
- 预期：`code=0`，返回 `data.id/name/team_code/captain_id/members`，`join_token` 存在（含 `token` 与 `expires_at`）。

### 用例3：已有队伍再次创建应返回现有队伍
- 前置：用例2已创建成功
- 步骤：学生A再次调用创建接口
  ```bash
  curl -s -X POST "http://localhost:8080/api/student/competitions/<season_id>/teams" \
    -H "Authorization: Bearer <STU_A_TOKEN>" \
    -H 'Content-Type: application/json' \
    -d '{"name":"测试队伍A-重复"}'
  ```
- 预期：`code=0`，返回仍为原队伍信息（不会创建第二支队伍）。

### 用例4：缺少队伍名称时创建失败
- 步骤：学生A创建队伍但不传 `name`
  ```bash
  curl -i -X POST "http://localhost:8080/api/student/competitions/<season_id>/teams" \
    -H "Authorization: Bearer <STU_A_TOKEN>" \
    -H 'Content-Type: application/json' \
    -d '{}'
  ```
- 预期：HTTP 400，`detail.code=2002`，`message=缺少队伍名称`

### 用例5：成员通过令牌加入队伍成功
- 前置：用例2成功后，队伍存在且有 `join_token`；或由队长刷新令牌：
  ```bash
  curl -s -X POST "http://localhost:8080/api/student/teams/<team_id>/join-token" \
    -H "Authorization: Bearer <STU_A_TOKEN>" \
    -H 'Content-Type: application/json'
  # 记录返回的 token
  ```
- 步骤：学生B使用令牌加入
  ```bash
  curl -s -X POST "http://localhost:8080/api/student/teams/join" \
    -H "Authorization: Bearer <STU_B_TOKEN>" \
    -H 'Content-Type: application/json' \
    -d '{"token":"<记录的令牌>"}'
  ```
- 预期：`code=0`，返回队伍信息，成员列表包含学生B；自动报名记录生成。

### 用例6：令牌过期或无效时加入失败
- 步骤：学生B使用无效或过期令牌加入
  ```bash
  curl -i -X POST "http://localhost:8080/api/student/teams/join" \
    -H "Authorization: Bearer <STU_B_TOKEN>" \
    -H 'Content-Type: application/json' \
    -d '{"token":"invalid-or-expired"}'
  ```
- 预期：HTTP 404 或 400，`detail.code=2004`，`message=令牌无效或已过期/令牌已过期`

### 用例7：查询我的队伍（无队伍 → 有队伍）
- 步骤1：学生B在未加入前查询
  ```bash
  curl -s -X GET "http://localhost:8080/api/student/competitions/<season_id>/my-team" \
    -H "Authorization: Bearer <STU_B_TOKEN>"
  ```
- 预期：`code=0`，`data=null`
- 步骤2：学生B加入成功后再次查询
  ```bash
  curl -s -X GET "http://localhost:8080/api/student/competitions/<season_id>/my-team" \
    -H "Authorization: Bearer <STU_B_TOKEN>"
  ```
- 预期：`code=0`，`data` 为队伍信息（含成员与加入记录）。

### 用例8：非队长刷新令牌应失败
- 步骤：学生B尝试刷新令牌
  ```bash
  curl -i -X POST "http://localhost:8080/api/student/teams/<team_id>/join-token" \
    -H "Authorization: Bearer <STU_B_TOKEN>" \
    -H 'Content-Type: application/json'
  ```
- 预期：HTTP 403，`detail.code=1003`，`message=仅队长可生成令牌`

## 对齐性核查结论
- 前端队伍报名页（`frontend/src/views/TeamEnroll.vue`）创建与加入分别调用：
  - 创建：`POST /student/competitions/{season_id}/teams`
  - 加入：`POST /student/teams/join`
- 后端学生路由（`backend/app/routers/student.py`）对应端点与校验：
  - 创建队伍：`create_team_for_season` → 校验 `_signup_open(season)` → 自动报名与令牌生成
  - 加入队伍：`join_team_by_token` → 校验令牌与 `_signup_open(season)` → 自动报名与历史记录
- 首页开放赛季列表（`backend/app/routers/public.py`）过滤条件与 `_signup_open` 等价（时间窗或 `allow_signup`）。

结论：前端调用接口未调错，报名开放校验在前后端已对齐；若出现“不能创建队伍”，优先检查赛季的报名窗口或 `allow_signup` 开关状态，以及学生登录有效性。

## 清理与注意事项
- 测试完成后可将报名开关恢复；必要时清理测试队伍与成员（需管理员接口支持）。
- 注意服务器时间与本地时区差异，避免误判报名窗口。